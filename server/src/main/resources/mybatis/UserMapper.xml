<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.dsc.jk.mapper.UserMapper">

    <!-- Base Result Map -->
    <resultMap id="baseResultMap" type="cn.dsc.jk.entity.UserEntity">
        <id column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="avatar_attach_id" property="avatarAttachId" jdbcType="BIGINT"/>
        <result column="account" property="account" jdbcType="VARCHAR"/>
        <result column="gender" property="gender" jdbcType="VARCHAR"/>
        <result column="phone" property="phone" jdbcType="VARCHAR"/>
        <result column="email" property="email" jdbcType="VARCHAR"/>
        <result column="locked_flag" property="lockedFlag" jdbcType="TINYINT"/>
        <result column="created_user_id" property="createdUserId" jdbcType="BIGINT"/>
        <result column="updated_user_id" property="updatedUserId" jdbcType="BIGINT"/>
        <result column="created_time" property="createdTime" jdbcType="TIMESTAMP"/>
        <result column="updated_time" property="updatedTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- Base Column List -->
    <sql id="Base_Column_List">
        user_id,
        user_name,
        avatar_attach_id,
        account,
        gender,
        phone,
        email,
        locked_flag,
        created_user_id,
        updated_user_id,
        created_time,
        updated_time
    </sql>

    <!-- UserSimpleDetail Result Map -->
    <resultMap id="userSimpleDetailResultMap" type="cn.dsc.jk.dto.user.UserSimpleDetail">
        <result column="user_id" property="userId" jdbcType="BIGINT"/>
        <result column="user_name" property="userName" jdbcType="VARCHAR"/>
        <result column="account" property="account" jdbcType="VARCHAR"/>
        <result column="password" property="password" jdbcType="VARCHAR"/>
        <result column="locked_flag" property="isLockFlag" jdbcType="TINYINT"/>
        <result column="avatar_attach_id" property="avatarAttachId" jdbcType="BIGINT"/>
    </resultMap>

    <!-- Select list with conditions -->
    <select id="selectList" resultMap="baseResultMap" parameterType="map">
        SELECT
        <include refid="Base_Column_List"/>
        FROM user
        <where>
            <if test="userName != null and userName != ''">
                AND user_name LIKE CONCAT('%', #{userName}, '%')
            </if>
            <if test="account != null and account != ''">
                AND account LIKE CONCAT('%', #{account}, '%')
            </if>
            <if test="phone != null and phone != ''">
                AND phone LIKE CONCAT('%', #{phone}, '%')
            </if>
            <if test="email != null and email != ''">
                AND email LIKE CONCAT('%', #{email}, '%')
            </if>
            <if test="lockedFlag != null">
                AND locked_flag = #{lockedFlag}
            </if>
            <if test="roleIds != null and roleIds.size() > 0">
                AND user_id IN (SELECT user_id FROM user_role_rel WHERE role_id IN
                <foreach collection="roleIds" item="roleId" open="(" separator="," close=")">
                    #{roleId}
                </foreach>
                )
            </if>
            <if test="deptIds != null and deptIds.size() > 0">
                AND user_id IN (SELECT user_id FROM user_dept_rel WHERE dept_id IN
                <foreach collection="deptIds" item="deptId" open="(" separator="," close=")">
                    #{deptId}
                </foreach>
                )
            </if>
        </where>
        ORDER BY user_id DESC
    </select>

    <!-- Select simple detail by account with inner join -->
    <select id="selectSimpleDetailByAccount" resultMap="userSimpleDetailResultMap">
        SELECT
            u.user_id,
            u.user_name,
            u.account,
            uc.password,
            u.locked_flag,
            u.avatar_attach_id
        FROM user u
        INNER JOIN user_credential uc ON u.user_id = uc.user_id
        WHERE u.account = #{account}
        LIMIT 1
    </select>

    <!-- Select simple detail by user id（不含密码，用于 /current 等接口） -->
    <select id="selectSimpleDetailById" resultMap="userSimpleDetailResultMap">
        SELECT
            user_id,
            user_name,
            account,
            locked_flag,
            avatar_attach_id
        FROM user
        WHERE user_id = #{userId}
        LIMIT 1
    </select>

</mapper>
